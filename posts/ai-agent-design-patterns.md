# AI Agent 设计模式与实战经验

> 从企业信贷流水分析 Agent 的实战出发，总结多阶协同 Agent 架构的设计模式。

## 为什么需要 Agent？

传统的 NLP 流水线在面对复杂的企业信贷流水分析场景时，暴露出明显的不足：

- **规则爆炸**：200+ 风控规则难以用 if-else 覆盖所有组合
- **上下文缺失**：单次推理无法还原企业经营全貌
- **灵活性差**：新增规则需要重新开发整条流水线

Agent 架构让我们能够将复杂任务拆解为**可编排的子任务**，每个子任务有明确的输入/输出契约。

## 多阶协同架构

我们最终采用的是「分类-计算-写作」三阶 Agent 架构：

```
┌─────────────┐
│   用户上传   │
│   流水文件   │
└──────┬──────┘
       │
  ┌────▼────┐
  │ OCR 引擎 │   ← 文档识别 & 结构化
  └────┬────┘
       │
  ┌────▼──────────┐
  │ 分类 Agent     │   ← 交易分类 & 标签
  │ (11大类标签)    │
  └────┬──────────┘
       │
  ┌────▼──────────┐
  │ 计算 Agent     │   ← 风控规则计算
  │ (200+ 规则)    │
  └────┬──────────┘
       │
  ┌────▼──────────┐
  │ 写作 Agent     │   ← 报告生成
  │ (结构化输出)    │
  └──────────────┘
```

### 1. 分类 Agent

分类 Agent 负责将原始交易流水按照 11 大类进行标注。核心设计决策：

- 使用 **Few-shot + CoT** 组合 Prompt
- 引入**置信度评分**，低于阈值的交由人工复核
- 支持**增量分类**，不必每次全量处理

```python
CLASSIFY_PROMPT = """
你是一个企业交易流水分类专家。
请将以下交易按照11个类别进行分类。

## 分类体系
1. 主营业务收入  2. 主营业务成本  3. 关联交易 ...

## 要求
- 每笔交易给出分类标签和置信度（0-1）
- 不确定的标注为 "待人工复核"
- 输出严格JSON格式

## 示例
输入：收到 XX建设集团 转账 500000 备注：工程款
输出：{"category": "主营业务收入", "confidence": 0.95}
"""
```

### 2. 计算 Agent

计算 Agent 基于分类结果执行 200+ 条风控规则。关键点：

- 规则引擎抽象为**可配置的规则树**
- 每条规则有**触发条件**和**严重程度**
- 支持规则间的**依赖关系和优先级**

### 3. 写作 Agent

写作 Agent 将分析结果组织为结构化报告，核心挑战是：

- 保持专业性的同时确保可读性
- 数据引用需要**精确到交易流水行号**
- 风险提示需要**分级展示**

## 实战经验总结

经过半年的迭代，我们总结出几条实战经验：

1. **Prompt 版本管理**：每次修改 Prompt 都做 A/B 对比测试
2. **评测体系先行**：在编写 Agent 前先建好评测数据集
3. **渐进式自动化**：先做半自动（人机协作），再逐步提升自动化率
4. **错误预算机制**：允许一定比例的误判，但严格控制漏判

> 📌 审查耗时从 **2小时降至5分钟**，这是 Agent 架构带来的最直观收益。

## 写在最后

AI Agent 不是万能药，但它确实为复杂业务场景提供了一种优雅的解决方案。关键在于**理解业务本质**，然后用合适的技术手段去实现。

作为产品经理，理解 Agent 的能力边界和设计模式，才能更好地定义产品方案、评估技术可行性。
